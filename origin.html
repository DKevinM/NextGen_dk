<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Air Origin Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .info {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 8px 10px;
      border-radius: 8px;
      font-family: system-ui, Arial, sans-serif;
      font-size: 13px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<div id="map"></div>
<div class="info">
  Click anywhere on the map to see where the air likely came from in the last few hours.
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>

<script>
  // Create the map (center roughly on Alberta)
  const map = L.map('map').setView([53.5, -113.5], 6);

  // Base layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Layer group for trajectories + footprint
  const trajLayerGroup = L.layerGroup().addTo(map);

  function styleTrajectory(feature) {
    return {
      weight: 2,
      opacity: 0.9
    };
  }

  map.on("click", async (e) => {
    const { lat, lng } = e.latlng;
    trajLayerGroup.clearLayers();

    // Little marker at click point
    L.circleMarker(e.latlng, { radius: 5 }).addTo(trajLayerGroup);

    try {
      const params = new URLSearchParams({
        lat: lat.toFixed(5),
        lon: lng.toFixed(5),
        hours_back: 4,
        n: 15
      });

      const resp = await fetch(`/api/trajectory?${params.toString()}`);
      if (!resp.ok) {
        console.error("Trajectory API error", resp.status);
        return;
      }
      const data = await resp.json();

      // 1) Trajectories
      L.geoJSON(data.trajectories, {
        style: styleTrajectory
      }).addTo(trajLayerGroup);

      // 2) Footprint as soft circles
      data.footprint.forEach(cell => {
        const radius = 300 + cell.count * 50; // metres
        L.circle([cell.lat, cell.lon], {
          radius: radius,
          weight: 0,
          fillOpacity: 0.25
        }).addTo(trajLayerGroup);
      });

      // 3) Popup with dominant direction
      const dom = data.dominant_direction;
      const popupHtml = `
        <b>Air origin (last 4 hours)</b><br/>
        Dominant sector: <b>${dom.sector ?? "N/A"}</b><br/>
        Mean bearing: ${dom.mean_bearing ? dom.mean_bearing.toFixed(0) + "&deg;" : "N/A"}<br/>
        Ensemble members: ${dom.samples || 0}
      `;
      L.popup()
        .setLatLng(e.latlng)
        .setContent(popupHtml)
        .openOn(map);

    } catch (err) {
      console.error("Error fetching trajectory", err);
    }
  });
</script>

</body>
</html>
