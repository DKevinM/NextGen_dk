<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPRI Facilities - Alberta</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìç</text></svg>">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .popup-content {
            min-width: 250px;
        }

        .popup-content h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .popup-content p {
            margin: 5px 0;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>NPRI Facilities - Alberta</h1>
        <p>All environmental reporting facilities in Alberta</p>
    </div>
    
    <div id="map"></div>

    <div id="loading" class="loading">
        <h3>Loading NPRI Data...</h3>
        <p>Fetching all Alberta facilities (this may take up to 30 seconds)...</p>
        <div id="progress">Starting...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the map centered on Alberta
        const map = L.map('map').setView([54.5, -115], 6);

        // Add base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        const loadingDiv = document.getElementById('loading');
        const progressDiv = document.getElementById('progress');

        // Function to fetch ALL paginated data
        async function fetchAllNPRIAlbertaData() {
            let allFeatures = [];
            let offset = 0;
            const batchSize = 1000; // Maximum features per request
            let hasMoreData = true;
            let requestCount = 0;

            // First, let's try to get a count of total features
            progressDiv.textContent = 'Checking total number of facilities...';
            
            const countUrl = 'https://maps-cartes.ec.gc.ca/arcgis/rest/services/STB_DGST/NPRI/MapServer/0/query?where=ProvinceCode=%27AB%27&returnCountOnly=true&f=json';
            
            try {
                const countResponse = await fetch(countUrl);
                const countData = await countResponse.json();
                const totalFeatures = countData.count;
                console.log(`Total Alberta facilities in database: ${totalFeatures}`);
                progressDiv.textContent = `Found ${totalFeatures} Alberta facilities. Downloading...`;
            } catch (error) {
                console.log('Could not get total count, proceeding anyway...');
            }

            // Fetch data in batches until we have everything
            while (hasMoreData) {
                requestCount++;
                progressDiv.textContent = `Fetching batch ${requestCount}...`;
                
                const url = `https://maps-cartes.ec.gc.ca/arcgis/rest/services/STB_DGST/NPRI/MapServer/0/query?where=ProvinceCode%3D%27AB%27&outFields=*&returnGeometry=true&f=geojson&outSR=4326&resultOffset=${offset}&resultRecordCount=${batchSize}`;
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.features && data.features.length > 0) {
                        allFeatures = allFeatures.concat(data.features);
                        offset += data.features.length;
                        progressDiv.textContent = `Fetched ${allFeatures.length} facilities so far...`;
                        
                        // If we got fewer features than requested, we've reached the end
                        if (data.features.length < batchSize) {
                            hasMoreData = false;
                        }
                    } else {
                        hasMoreData = false;
                    }
                    
                    // Small delay to be respectful to the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    console.error(`Error fetching batch ${requestCount}:`, error);
                    hasMoreData = false;
                }
            }
            
            return allFeatures;
        }

        // Alternative: Try a simpler approach with just one larger request
        async function fetchNPRIAlbertaSimple() {
            progressDiv.textContent = 'Fetching all Alberta facilities in one request...';
            
            // Try to get a larger batch - some ArcGIS servers allow up to 2000-5000
            const url = 'https://maps-cartes.ec.gc.ca/arcgis/rest/services/STB_DGST/NPRI/MapServer/0/query?where=ProvinceCode%3D%27AB%27&outFields=*&returnGeometry=true&f=geojson&outSR=4326&resultRecordCount=5000';
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.features || [];
            } catch (error) {
                console.error('Error in simple fetch:', error);
                return [];
            }
        }

        // Load and display NPRI data
        console.log('Fetching ALL NPRI Alberta data...');
        
        // Try the simple approach first, then fall back to paginated if needed
        fetchNPRIAlbertaSimple()
            .then(features => {
                console.log(`Simple fetch returned ${features.length} features`);
                
                if (features.length < 100) {
                    // If we got very few features, try the paginated approach
                    console.log('Too few features, trying paginated approach...');
                    return fetchAllNPRIAlbertaData();
                }
                return features;
            })
            .then(allFeatures => {
                console.log(`Total Alberta facilities loaded: ${allFeatures.length}`);
                
                if (allFeatures.length === 0) {
                    throw new Error('No facilities were loaded');
                }

                // Group by sector to see what we have
                const sectors = {};
                allFeatures.forEach(feature => {
                    const sector = feature.properties.SectorDescriptionEn || 'Unknown';
                    sectors[sector] = (sectors[sector] || 0) + 1;
                });
                
                console.log('Sectors found:', sectors);
                
                let plottedCount = 0;
                let missingCoords = 0;
                
                // Plot all facilities as simple dots
                allFeatures.forEach(feature => {
                    const props = feature.properties;
                    let lat, lng;
                    
                    // Get coordinates from geometry or properties
                    if (feature.geometry && feature.geometry.type === 'Point') {
                        [lng, lat] = feature.geometry.coordinates;
                    } else {
                        lat = props.Latitude;
                        lng = props.Longitude;
                    }
                    
                    // Only create marker if we have valid coordinates
                    if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        // Color code by sector
                        const colors = {
                            'Conventional Oil and Gas extraction': '#e74c3c',
                            'Oil Sands Extraction': '#c0392b', 
                            'Electric Power Generation, Transmission and Distribution': '#3498db',
                            'Mining and Quarrying': '#9b59b6',
                            'Waste Treatment and Disposal': '#2ecc71',
                            'Chemicals Industry': '#f39c12',
                            'Metallurgy': '#34495e',
                            'Pulp and Paper': '#16a085'
                        };
                        
                        const sector = props.SectorDescriptionEn || 'Other';
                        const color = colors[sector] || '#95a5a6';
                        
                        L.circleMarker([lat, lng], {
                            radius: 5,
                            fillColor: color,
                            color: '#2c3e50',
                            weight: 1,
                            opacity: 0.8,
                            fillOpacity: 0.7
                        })
                        .bindPopup(createPopupContent(props))
                        .addTo(map);
                        
                        plottedCount++;
                    } else {
                        missingCoords++;
                    }
                });
                
                console.log(`Plotted ${plottedCount} facilities, ${missingCoords} missing coordinates`);
                
                loadingDiv.innerHTML = `
                    <h3>Data Loaded Successfully!</h3>
                    <p>Total facilities: ${allFeatures.length}</p>
                    <p>Plotted on map: ${plottedCount}</p>
                    <p>Click any dot to see facility details</p>
                    <button onclick="this.parentElement.style.display='none'">Close</button>
                `;
                
            })
            .catch(error => {
                console.error('Error loading data:', error);
                loadingDiv.innerHTML = `
                    <h3>Error Loading Data</h3>
                    <p>${error.message}</p>
                    <p>Try refreshing the page or check the console for details.</p>
                `;
            });

        function createPopupContent(props) {
            return `
                <div class="popup-content">
                    <h3>${props.CompanyName || 'Unknown Company'}</h3>
                    <p><strong>Facility:</strong> ${props.FacilityName || 'N/A'}</p>
                    <p><strong>Sector:</strong> ${props.SectorDescriptionEn || 'N/A'}</p>
                    <p><strong>Location:</strong> ${props.City || 'N/A'}, ${props.ProvinceCode || 'N/A'}</p>
                    <p><strong>Report Year:</strong> ${props.ReportYear || 'N/A'}</p>
                    <p><strong>NAICS:</strong> ${props.NAICS__Code_SCIAN || 'N/A'}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
