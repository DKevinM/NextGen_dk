<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPRI Facilities - Alberta</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìç</text></svg>">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .popup-content {
            min-width: 250px;
        }

        .popup-content h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .popup-content p {
            margin: 5px 0;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 400px;
        }

        .sector-progress {
            margin: 10px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>NPRI Facilities - Alberta</h1>
        <p>All environmental reporting facilities in Alberta</p>
    </div>
    
    <div id="map"></div>

    <div id="loading" class="loading">
        <h3>Loading NPRI Data...</h3>
        <p>Fetching facilities by sector (this will take 1-2 minutes)...</p>
        <div id="progress">Initializing...</div>
        <div id="sectorProgress"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the map centered on Alberta
        const map = L.map('map').setView([53.5, -114], 6);

        // Add base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        const loadingDiv = document.getElementById('loading');
        const progressDiv = document.getElementById('progress');
        const sectorProgressDiv = document.getElementById('sectorProgress');

        // List of major sectors to query individually
        const sectors = [
            'Oil and Gas',
            'Mining',
            'Manufacturing',
            'Electric Power',
            'Waste Treatment',
            'Chemicals',
            'Metals',
            'Pulp and Paper',
            'Cement'
        ];

        // More specific sector queries based on common NPRI sectors
        const sectorQueries = [
            { name: 'Conventional Oil and Gas', where: "SectorDescriptionEn LIKE '%Oil and Gas%'" },
            { name: 'Oil Sands', where: "SectorDescriptionEn LIKE '%Oil Sands%'" },
            { name: 'Mining', where: "SectorDescriptionEn LIKE '%Mining%'" },
            { name: 'Electric Power', where: "SectorDescriptionEn LIKE '%Electric Power%'" },
            { name: 'Waste Treatment', where: "SectorDescriptionEn LIKE '%Waste%'" },
            { name: 'Chemicals', where: "SectorDescriptionEn LIKE '%Chemical%'" },
            { name: 'Metals', where: "SectorDescriptionEn LIKE '%Metal%'" },
            { name: 'Pulp and Paper', where: "SectorDescriptionEn LIKE '%Pulp%' OR SectorDescriptionEn LIKE '%Paper%'" },
            { name: 'Cement', where: "SectorDescriptionEn LIKE '%Cement%'" },
            { name: 'Other Manufacturing', where: "SectorDescriptionEn LIKE '%Manufacturing%' AND SectorDescriptionEn NOT LIKE '%Chemical%' AND SectorDescriptionEn NOT LIKE '%Metal%'" }
        ];

        // Color scheme for different sectors
        const sectorColors = {
            'Conventional Oil and Gas': '#e74c3c',
            'Oil Sands': '#c0392b',
            'Mining': '#9b59b6',
            'Electric Power': '#3498db',
            'Waste Treatment': '#2ecc71',
            'Chemicals': '#f39c12',
            'Metals': '#34495e',
            'Pulp and Paper': '#16a085',
            'Cement': '#d35400',
            'Other Manufacturing': '#7f8c8d',
            'Other': '#95a5a6'
        };

        async function fetchSectorData(sectorQuery, attempt = 1) {
            const baseUrl = 'https://maps-cartes.ec.gc.ca/arcgis/rest/services/STB_DGST/NPRI/MapServer/0/query';
            const whereClause = `ProvinceCode='AB' AND (${sectorQuery.where})`;
            const url = `${baseUrl}?where=${encodeURIComponent(whereClause)}&outFields=*&returnGeometry=true&f=geojson&outSR=4326&resultRecordCount=2000`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'API error');
                }
                
                return data.features || [];
            } catch (error) {
                console.warn(`Attempt ${attempt} failed for ${sectorQuery.name}:`, error);
                
                if (attempt < 3) {
                    // Wait and retry
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    return fetchSectorData(sectorQuery, attempt + 1);
                }
                
                return [];
            }
        }

        async function fetchAllSectors() {
            let allFeatures = [];
            let completedSectors = 0;
            const totalSectors = sectorQueries.length;

            // Update progress
            progressDiv.textContent = `Fetching data for ${totalSectors} sectors...`;
            sectorProgressDiv.innerHTML = '';

            for (const sectorQuery of sectorQueries) {
                const sectorDiv = document.createElement('div');
                sectorDiv.className = 'sector-progress';
                sectorDiv.id = `sector-${sectorQuery.name.replace(/\s+/g, '-')}`;
                sectorDiv.innerHTML = `üîÑ ${sectorQuery.name}...`;
                sectorProgressDiv.appendChild(sectorDiv);

                try {
                    const features = await fetchSectorData(sectorQuery);
                    allFeatures = allFeatures.concat(features);
                    
                    // Update progress for this sector
                    const sectorElement = document.getElementById(`sector-${sectorQuery.name.replace(/\s+/g, '-')}`);
                    sectorElement.innerHTML = `‚úÖ ${sectorQuery.name}: ${features.length} facilities`;
                    
                    // Plot these features immediately
                    plotFeatures(features, sectorQuery.name);
                    
                    completedSectors++;
                    progressDiv.textContent = `Completed ${completedSectors}/${totalSectors} sectors (${allFeatures.length} total facilities)`;
                    
                    // Small delay to be nice to the server
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`Failed to fetch ${sectorQuery.name}:`, error);
                    const sectorElement = document.getElementById(`sector-${sectorQuery.name.replace(/\s+/g, '-')}`);
                    sectorElement.innerHTML = `‚ùå ${sectorQuery.name}: Failed`;
                    completedSectors++;
                }
            }

            return allFeatures;
        }

        function plotFeatures(features, sectorName) {
            let plottedCount = 0;
            
            features.forEach(feature => {
                const props = feature.properties;
                let lat, lng;
                
                // Get coordinates from geometry or properties
                if (feature.geometry && feature.geometry.type === 'Point') {
                    [lng, lat] = feature.geometry.coordinates;
                } else {
                    lat = props.Latitude;
                    lng = props.Longitude;
                }
                
                // Only create marker if we have valid coordinates
                if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    const color = sectorColors[sectorName] || sectorColors['Other'];
                    
                    L.circleMarker([lat, lng], {
                        radius: 5,
                        fillColor: color,
                        color: '#2c3e50',
                        weight: 1,
                        opacity: 0.8,
                        fillOpacity: 0.7
                    })
                    .bindPopup(createPopupContent(props))
                    .addTo(map);
                    
                    plottedCount++;
                }
            });
            
            console.log(`Plotted ${plottedCount} facilities for ${sectorName}`);
            return plottedCount;
        }

        // Start loading data
        console.log('Starting multi-sector data fetch...');
        
        fetchAllSectors()
            .then(allFeatures => {
                console.log(`Total facilities loaded from all sectors: ${allFeatures.length}`);
                
                // Summary by sector
                const sectorSummary = {};
                allFeatures.forEach(feature => {
                    const sector = feature.properties.SectorDescriptionEn || 'Unknown';
                    sectorSummary[sector] = (sectorSummary[sector] || 0) + 1;
                });
                
                console.log('Sector summary:', sectorSummary);
                
                loadingDiv.innerHTML = `
                    <h3>Data Loaded Successfully!</h3>
                    <p><strong>Total facilities loaded: ${allFeatures.length}</strong></p>
                    <p>Sectors found: ${Object.keys(sectorSummary).length}</p>
                    <div style="max-height: 200px; overflow-y: auto; margin: 10px 0;">
                        ${Object.entries(sectorSummary).map(([sector, count]) => 
                            `<div style="padding: 2px 0;">‚Ä¢ ${sector}: ${count}</div>`
                        ).join('')}
                    </div>
                    <button onclick="this.parentElement.style.display='none'" style="width: 100%; padding: 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                `;
            })
            .catch(error => {
                console.error('Failed to load data:', error);
                loadingDiv.innerHTML = `
                    <h3>Error Loading Data</h3>
                    <p>${error.message}</p>
                    <p>Some data may still have been loaded. Check the console for details.</p>
                `;
            });

        function createPopupContent(props) {
            return `
                <div class="popup-content">
                    <h3>${props.CompanyName || 'Unknown Company'}</h3>
                    <p><strong>Facility:</strong> ${props.FacilityName || 'N/A'}</p>
                    <p><strong>Sector:</strong> ${props.SectorDescriptionEn || 'N/A'}</p>
                    <p><strong>Location:</strong> ${props.City || 'N/A'}, ${props.ProvinceCode || 'N/A'}</p>
                    <p><strong>Report Year:</strong> ${props.ReportYear || 'N/A'}</p>
                    <p><strong>NAICS:</strong> ${props.NAICS__Code_SCIAN || 'N/A'}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
