<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPRI Facilities - Alberta</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .popup-content {
            min-width: 250px;
        }

        .popup-content h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .popup-content p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>NPRI Facilities - Alberta</h1>
        <p>All environmental reporting facilities in Alberta</p>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the map centered on Alberta
        const map = L.map('map').setView([54.5, -115], 6);

        // Add base tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Load and display NPRI data - filter for Alberta only
        fetch('https://maps-cartes.ec.gc.ca/arcgis/rest/services/STB_DGST/NPRI/MapServer/0/query?where=1=1&outFields=*&returnGeometry=true&f=geojson&outSR=4326')
            .then(response => response.json())
            .then(data => {
                // Filter for Alberta facilities only
                const albertaFacilities = data.features.filter(feature => 
                    feature.properties.ProvinceCode === 'AB'
                );
                
                console.log(`Loaded ${albertaFacilities.length} Alberta facilities`);
                
                // Plot all facilities as simple dots
                albertaFacilities.forEach(feature => {
                    const props = feature.properties;
                    let lat, lng;
                    
                    // Get coordinates from geometry or properties
                    if (feature.geometry && feature.geometry.type === 'Point') {
                        [lng, lat] = feature.geometry.coordinates;
                    } else {
                        // Fallback to properties if geometry is null
                        lat = props.Latitude;
                        lng = props.Longitude;
                    }
                    
                    // Only create marker if we have valid coordinates
                    if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        // Create a simple circle marker (dot)
                        const dot = L.circleMarker([lat, lng], {
                            radius: 6,
                            fillColor: "#e74c3c",
                            color: "#c0392b",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        })
                        .bindPopup(createPopupContent(props))
                        .addTo(map);
                    }
                });
                
                console.log('All Alberta facilities plotted as dots');
            })
            .catch(error => console.error('Error loading data:', error));

        function createPopupContent(props) {
            return `
                <div class="popup-content">
                    <h3>${props.CompanyName || 'Unknown Company'}</h3>
                    <p><strong>Facility:</strong> ${props.FacilityName || 'N/A'}</p>
                    <p><strong>Sector:</strong> ${props.SectorDescriptionEn || 'N/A'}</p>
                    <p><strong>Location:</strong> ${props.City || 'N/A'}, ${props.ProvinceCode || 'N/A'}</p>
                    <p><strong>Report Year:</strong> ${props.ReportYear || 'N/A'}</p>
                    <p><strong>NAICS:</strong> ${props.NAICS__Code_SCIAN || 'N/A'}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
